name: Judge-Deploy

on:
  workflow_call:
    inputs:
      env:
        type: string
        required: true
      build-base:
        type: boolean
        default: true
  workflow_dispatch:
    inputs:
      env:
        type: string
        default: dev
        description: deployment target environment
      build-base:
        type: boolean
        default: true
        description: build base image or not

jobs:
  image-build:
    uses: ./.github/workflows/judge-image-build.yml
    with:
      env: ${{ inputs.env }}
      build-base: ${{ inputs.build-base }}

  # deploy:
  #   needs: [image-build]
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     id-token: write

  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: google-github-actions/auth@v2
  #       with:
  #         workload_identity_provider: projects/190778459730/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider
  #         service_account: gce-judge-deployer@library-checker-project.iam.gserviceaccount.com
  #         token_format: access_token
  #     - uses: google-github-actions/setup-gcloud@v2


  #     - id: instance-template-name
  #       run: echo "name=v2-${{ inputs.env }}-judge-template-$(date +'%Y-%m-%d-%H-%M-%S')" >> $GITHUB_OUTPUT

  #     - name: Create instance template
  #       run: >
  #         gcloud compute instance-templates create ${{ steps.instance-template-name.outputs.name }}
  #         --preemptible
  #         --machine-type c2-standard-4
  #         --image-family v2-${{ inputs.env }}-judge-image
  #         --service-account gce-judge@library-checker-project.iam.gserviceaccount.com
  #         --scopes default,cloud-platform
  #         --boot-disk-size 50GB
  #         --network-interface=no-address
  #         --metadata env=${{ inputs.env }}

  #     - name: Update instance group
  #       run: >
  #         gcloud compute instance-groups managed rolling-action
  #         start-update ${{ inputs.env }}-judge-instance-group
  #         --region asia-northeast1
  #         --version=template=${{ steps.instance-template-name.outputs.name }}
